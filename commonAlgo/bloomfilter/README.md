### 算法题目

如果一个黑名单网站包含100亿个黑名单网页，每个网页最多占64B，设计一个系统，判断当前的URL是否在这个黑名单当中，要求额外空间不超过30GB，允许误差率为万分之一。

**解题思路：布隆过滤器**

### 基础介绍

> 布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量(位图)和一系列随机映射函数（哈希函数）。
> 布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。

#### **实际工程的应用**

实际上，布隆过滤器广泛应用于网页黑名单系统、垃圾邮件过滤系统、爬虫网址判重系统等，有人会想，如果直接将网页URL存入数据库进行查找不就好了，或者建立一个哈希表进行查找不就OK了。

当数据量小的时候，这么思考是对的，但如果整个网页黑名单系统包含100亿个网页URL，在数据库查找是很费时的，并且如果每个URL空间为64B，那么需要内存为640GB，一般的服务器很难达到这个需求。

```
100 0000 0000 * 64 / 8 / 1000 /1000 /1000 = 640 GB

改用bitmap
100 0000 0000 / 8 / 1000 /1000 /1000
布隆过滤器中 99.9%准确率需要18G, 99.99%准确率需要24G, 99.999%准确率需要30G 一般服务器即可到达。
```

那么，在这种内存不够且检索速度慢的情况下，不妨考虑下布隆过滤器，但业务上要可以忍受判断失误率。

![img](https://mmbiz.qpic.cn/mmbiz_png/vdmJXwBkyWscNbwKdYgDfZ10InJuERXeWSzJl7rEZ1Xd6gKbqkyhBRQGc3fcsN9Zc21NW8F8rwgp3Wb1NLO4aw/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)布隆过滤器结构图

#### **位图（bitmap）**

布隆过滤器其中重要的实现就是位图的实现，也就是位数组，并且在这个数组中每一个位置只占有1个bit，而每个bit只有0和1两种状态。如上图bit array所示！bitarray也叫bitmap，大小也就是布隆过滤器的大小。

假设一种有k个哈希函数，且每个哈希函数的输出范围都大于m，接着将输出值对k取余（%m）,就会得到k个[0, m-1]的值，由于每个哈希函数之间相互独立，因此这k个数也相互独立，最后将这k个数对应到bitarray上并标记为1。

等判断时，将输入对象经过这k个哈希函数计算得到k个值，然后判断对应bitarray的k个位置是否都为1，**如果有一个不为1，那么这个输入对象则不在这个集合中，也就不是黑名单了！如果都是1，那说明在集合中，但有可能会误判断**，由于当输入对象过多，而集合也就是bitarray过小，则会出现大部分为1的情况，那样就容易发生误判！因此使用布隆过滤器是需要容忍错误率的，即使很低很低！

### 布隆过滤器重要参数计算

通过上面的描述，可以知道，如果输入量过大，而bitarray空间的大小又很小，那么误判率就会上升。那么bitarray空间大小怎么确定呢？不要慌，已经有人通过数据推倒出公式了！！！哈哈，直接用～

假设输入对象个数为n，bitarray大小（也就是布隆过滤器大小）为m，所容忍的误判率p和哈希函数的个数k。计算公式如下：（**小数向上取整**）

```latex
bit array大小
m  =  -(n * ln(p))/(ln(2)^2)

哈希函数个数
k  =  ln(2) * (m / n)  = 0.7 * m / n 

容错率
p = (1 - e^(-nk/m))^k
```

**注意：由于计算的m和k可能是小数，那么需要经过向上取整，此时需要重新计算误判率p！**

假设一个网页黑名单有URL为100亿，每个样本为64B，失误率为0.01%，经过上述公式计算后，需要布隆过滤器大小为25GB，这远远小于使用哈希表的640GB的空间。

并且由于是通过hash进行查找的，所以基本都可以在O(1)的时间完成！

### 布隆过滤器的测试

测试用例来自GitHub的CPP版的布隆过滤器！
GitHub地址：https://github.com/ArashPartow/bloom

![img](https://mmbiz.qpic.cn/mmbiz_png/vdmJXwBkyWscNbwKdYgDfZ10InJuERXeP84ANRLRk4ohWhPJJxmibJZt6HjGnMAms0ibSsrCZoVnCgfxsMhniaiasQ/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)测试数据展示


我们关心的主要是Queries列和FPQ列，可以看出，输入对象为1万多个时也会出现错误的访问，当然概率极低的，那么如果我们一直增加Queries的次数，其误判率是怎么样的！

![img](https://mmbiz.qpic.cn/mmbiz_png/vdmJXwBkyWscNbwKdYgDfZ10InJuERXeUMH4v5iaLHzqx5OGhMvdpoXbnySibiczf6iahTgHgm2cv8b3xlNIMJ9Gmw/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)测试数据展示


可以看到作者一共测试到了1715万次输入，而平均的误判率为0.00023738，充分说明了布隆过滤器的有效性。